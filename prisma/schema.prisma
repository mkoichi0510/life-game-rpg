// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// カテゴリ（ユーザーが自由に作成・編集可能）
model Category {
  id              String   @id @default(cuid())
  userId          String
  name            String
  visible         Boolean  @default(true)
  order           Int      @default(0)
  rankWindowDays  Int      @default(7) // 週ランク判定期間
  xpPerPlay       Int      @default(10) // 1プレイあたりのXP
  xpPerSp         Int      @default(20) // SPに変換するために必要なXP
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user                 User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  actions              Action[]
  dailyCategoryResults DailyCategoryResult[]
  playerState          PlayerCategoryState?
  skillTrees           SkillTree[]
  seasonalTitles       SeasonalTitle[]
  spendLogs            SpendLog[]

  @@index([userId, visible, order])
}

// アクション（プレイ定義）
model Action {
  id         String   @id @default(cuid())
  categoryId String
  userId     String
  label      String
  unit       String?  // 単位（回、分、km など）
  visible    Boolean  @default(true)
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  playLogs PlayLog[]

  @@index([userId, categoryId, visible, order])
}

// プレイログ
model PlayLog {
  id       String   @id @default(cuid())
  at       DateTime @default(now()) // ISO datetime
  dayKey   String   // YYYY-MM-DD（ローカル）
  actionId String
  userId   String
  note     String?
  quantity Int?     // 数量（回数・分など）
  createdAt DateTime @default(now())

  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  action                Action                 @relation(fields: [actionId], references: [id], onDelete: Cascade)
  dailyCategoryResults  DailyCategoryResult[]

  @@index([userId, dayKey])
  @@index([userId, actionId])
}

// 日次リザルト（確定状態管理）
model DailyResult {
  userId      String
  dayKey      String   // YYYY-MM-DD
  status      String   @default("draft") // "draft" | "confirmed"
  confirmedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user           User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  categoryResults DailyCategoryResult[]

  @@id([userId, dayKey])
}

// 日次カテゴリ別リザルト
model DailyCategoryResult {
  id          String   @id @default(cuid())
  dayKey      String
  categoryId  String
  userId      String
  playCount   Int      @default(0)
  xpEarned    Int      @default(0)
  spEarned    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  dailyResult DailyResult @relation(fields: [userId, dayKey], references: [userId, dayKey], onDelete: Cascade)
  category    Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  playLogs    PlayLog[]

  @@unique([userId, dayKey, categoryId])
  @@index([userId, categoryId])
}

// プレイヤーのカテゴリ別ステータス
model PlayerCategoryState {
  id         String   @id @default(cuid())
  categoryId String   @unique
  userId     String
  xpTotal    Int      @default(0) // 確定済み累計XP
  spUnspent  Int      @default(0) // 未使用SP
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  @@index([userId])
}

// スキルツリー（恒久称号）
model SkillTree {
  id         String   @id @default(cuid())
  categoryId String
  userId     String
  name       String
  visible    Boolean  @default(true)
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  category   Category     @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  skillNodes SkillNode[]

  @@index([userId, categoryId, visible, order])
}

// スキルノード（恒久称号の各段階）
model SkillNode {
  id        String   @id @default(cuid())
  treeId    String
  userId    String
  order     Int
  title     String
  costSp    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  tree          SkillTree      @relation(fields: [treeId], references: [id], onDelete: Cascade)
  unlockedNodes UnlockedNode[]

  @@unique([userId, treeId, order])
  @@index([userId, treeId, order])
}

// 解放済みノード
model UnlockedNode {
  id         String   @id @default(cuid())
  nodeId     String
  userId     String
  unlockedAt DateTime @default(now())

  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  node SkillNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@unique([userId, nodeId])
  @@index([userId, unlockedAt])
}

// 週ランク称号（維持・変動型）
model SeasonalTitle {
  id           String   @id @default(cuid())
  categoryId   String
  userId       String
  label        String
  minSpEarned  Int      // 直近N日で必要なSP合計
  order        Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([userId, categoryId, order])
}

// SP消費履歴
model SpendLog {
  id         String   @id @default(cuid())
  at         DateTime @default(now())
  categoryId String
  userId     String
  type       String   // "unlock_node"など
  costSp     Int
  refId      String   // nodeIdなど
  dayKey     String?  // YYYY-MM-DD
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([userId, categoryId, at])
}

// Auth.js (NextAuth v5) models
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?

  categories           Category[]
  actions              Action[]
  playLogs             PlayLog[]
  dailyResults         DailyResult[]
  dailyCategoryResults DailyCategoryResult[]
  playerCategoryStates PlayerCategoryState[]
  skillTrees           SkillTree[]
  skillNodes           SkillNode[]
  unlockedNodes        UnlockedNode[]
  seasonalTitles       SeasonalTitle[]
  spendLogs            SpendLog[]

  accounts Account[]
  sessions Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
